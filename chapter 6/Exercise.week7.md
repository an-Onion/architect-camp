# æå®¢æ—¶é—´ã€Šæ¶æ„å¸ˆè®­ç»ƒè¥ã€‹ç¬¬ä¸ƒå‘¨è¯¾åä½œä¸š

## ç¬¬ä¸€é¢˜

> æ€§èƒ½å‹æµ‹çš„æ—¶å€™ï¼Œéšç€å¹¶å‘å‹åŠ›çš„å¢åŠ ï¼Œç³»ç»Ÿå“åº”æ—¶é—´å’Œååé‡å¦‚ä½•å˜åŒ–ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

è´´ä¸€å¼ ç»å…¸çš„çš„æ€§èƒ½æµ‹è¯•æ›²çº¿å›¾ï¼š

![æ€§èƒ½æµ‹è¯•æ›²çº¿][1]

å¹¶å‘é‡ä¸å“åº”æ—¶é—´å’Œååé‡çš„å…³ç³»ï¼Œé€šä¿—æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

1. è½»è´Ÿè½½é˜¶æ®µ

    è¿™ä¸ªé˜¶æ®µè´Ÿè½½è¿œæœªè¾¾åˆ°ç³»ç»Ÿè½¯ç¡¬ä»¶ç“¶é¢ˆï¼Œèµ„æºéšæ—¶å¾…å‘½ï¼Œè¯·æ±‚è¢«ä»¥æœ€å¿«çš„é€Ÿåº¦è®¡ç®—è¿”å›ã€‚å“åº”æ—¶é—´ä¿æŒå¹³ç¨³ï¼Œå‡ ä¹ä¸ºæœ€çŸ­æ¶ˆè€—æ—¶é—´ï¼›ååé‡ä¸è´Ÿè½½ä¹Ÿå‘ˆçº¿æ€§å¢é•¿å…³ç³»ã€‚

2. é‡è´Ÿè½½é˜¶æ®µ

    è¯¥é˜¶æ®µç³»ç»Ÿæ— æ³•å†å®ç°ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰å“åº”äº†ï¼Œå—æŸäº›èµ„æºçš„é™åˆ¶ï¼Œä¸€äº›è¯·æ±‚è¢«é˜»å¡åœ¨é˜Ÿåˆ—å†…ï¼Œä½†è½¯ç¡¬ä»¶ä¾æ—§å¯ä»¥æ‰¿å—è¿™ç§è´Ÿè½½ï¼›å“åº”æ—¶é—´å¼€å§‹å•è°ƒé€’å¢ï¼Œååé‡ä¿æŒç›¸å¯¹ç¨³å®šã€‚

3. å‹å®é˜¶æ®µ

    è¿™ä¸ªé˜¶æ®µè½¯ç¡¬ä»¶å·²æ— æ³•æ‰¿å—è¿™ä¹ˆå¤§çš„è´Ÿè½½äº†ï¼Œç³»ç»Ÿèµ„æºæ¶ˆè€—æ®†å°½ï¼›å“åº”æ—¶é—´å‚ç›´ä¸Šæ¶¨ï¼Œååé‡å‘ˆæ–­å´–å¼ä¸‹é™ã€‚

## ç¬¬äºŒé¢˜

> ç”¨ä½ ç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€å†™ä¸€ä¸ª web æ€§èƒ½å‹æµ‹å·¥å…·ï¼Œè¾“å…¥å‚æ•°ï¼šURLã€è¯·æ±‚æ€»æ¬¡æ•°ã€å¹¶å‘æ•°ã€‚è¾“å‡ºå‚æ•°ï¼šå¹³å‡å“åº”æ—¶é—´ã€95%å“åº”æ—¶é—´ã€‚ç”¨è¿™ä¸ªæµ‹è¯•å·¥å…·ä»¥ 10 å¹¶å‘ã€100 æ¬¡è¯·æ±‚å‹æµ‹ç™¾åº¦ï¼ˆæˆ–å…¶ä»–ç½‘ç«™ï¼‰

æˆ‘æ˜¯å‰ç«¯å¼€å‘ï¼Œç”¨ Typescriptï¼ˆJavascript è¶…é›†ï¼‰å†™å¹¶å‘æœ‰å¤©ç„¶çš„è¯­è¨€ä¼˜åŠ¿ğŸ˜„

## é¢„çƒ­

å…ˆå‡†å¤‡ä¸¤ä¸ªæ–¹æ³•ï¼Œå³å“åº”æ—¶é—´çš„å¹³å‡æ•°å’Œ 95% æ•°ï¼š

```typescript
// utils.ts
export function response_avg(arr: number[]): number {
  return arr.reduce((p, c) => p + c, 0) / arr.length;
}

export function response_95(arr: number[]): number {
  arr.sort((a, b) => a - b);
  const idx: number = (arr.length * 0.95) | 0;
  return arr[idx];
}
```

## fetch æ–¹æ³•

è¯·æ±‚å‡½æ•°æˆ‘ç”¨åˆ°äº†[axios][2]åº“ï¼Œä½†æ˜¯åŸç”Ÿçš„ axios è¯·æ±‚ä¸èƒ½è®¡ç®—å“åº”æ—¶é—´ï¼Œæ‰€ä»¥é­”æ”¹äº†ä¸€ä¸‹ï¼š

1. ç»™å®ƒçš„æ‹¦æˆªå™¨åŠ äº†ä¸¤ä¸ªä¸­é—´ä»¶ï¼šä¸º request æ·»åŠ å‘èµ·æ—¶é—´ï¼Œä¸º response è®¡ç®—å“åº”æ—¶é—´
2. å°è£…äº† axiosï¼Œexport `fetch` æ–¹æ³•å¹¶è¿”å›æœ¬æ¬¡è¯·æ±‚çš„å“åº”æ—¶é—´

```typescript
// fetch.ts
import axios from "axios";

axios.interceptors.request.use( (config: Config) => {
  config.meta = { requestStartedAt: new Date().getTime() }
  return config;
})

axios.interceptors.response.use((response: Response) => {
  response.responseTime = new Date().getTime() - response.config.meta.requestStartedAt;
  return response;
});

export function fetch(url: string): Promise<number> {
  return axios(url).then((response: Response) => response.responseTime);
}
```

## è¿”å›ç»“æœ

TS çš„å¥½å¤„å°±æ˜¯ä¸ç”¨å¼€å¤šçº¿ç¨‹ï¼Œå®ƒåªæœ‰å•çº¿ç¨‹ï¼Œå¤©ç„¶çš„å¼‚æ­¥è¯­è¨€ï¼›ç›´æ¥`Promise.all` å°±å¯ä»¥å‘é€ä¸€ç»„å¼‚æ­¥è¯·æ±‚äº†ğŸ˜…

å®ç°ä¸Šå¦‚ä¸‹ï¼š

1. å…ˆç”¨è¯·æ±‚æ€»æ•° `/` å¹¶å‘æ•°è®¡ç®—è½®æ•°
2. æ¯ä¸€è½®ç”¨ `Promise.all(gets)` å¹¶å‘è¯·æ±‚
3. `await` è¯¥è½®å“åº”æ—¶é—´å¹¶ä¿å­˜ç»“æœ
4. å¼€å§‹ä¸‹ä¸€è½®ï¼Œé‡å¤æ­¥éª¤2ï¼Œç›´åˆ°ç»“æŸ

`p.s.` ç®€å•èµ·è§æˆ‘æ²¡æœ‰å¯¹æœ€åä¸€è½®ä¸æ»¡è¶³å¹¶å‘æ€»æ•°çš„æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œæˆ‘æƒ³ç°å®ä¸­ä¹Ÿä¸ä¼šå§

```typescript
import {fetch} from './fetch';
import {response_95, response_avg} from './utils';

async function getResult(url: string, concurrency: number, times: number) {
  const costs: number[] = [];
  const rounds: number = Math.ceil( times / concurrency );

  for (let i = 0; i < rounds; i++) {
    const gets: Promise<number>[] = [...Array(concurrency)].map(() => fetch(url));
    const response:  number[] = await Promise.all(gets);
    costs.push(...response);
  }

  return {
    avg: response_avg(costs),
    res_95: response_95(costs),
  };
}
```

æœ€åï¼Œæˆ‘è¯•äº†ä¸€ä¸‹ç™¾åº¦çš„å“åº”ç»“æœï¼š`{ avg: 2661.06, res_95: 3801 }`ï¼Œ å¹³å‡è¦ 2 ç§’å¤šï¼›æ„Ÿè§‰æŒºæ…¢çš„ï¼Œçœ‹äº†ä¸€ä¸‹æµè§ˆå™¨åŠ è½½æ—¶é—´ä¹Ÿå·®ä¸å¤šï¼Œåº”è¯¥æ˜¯ç™¾åº¦éœ€è¦åŠ è½½çš„èµ„æºå¤ªå¤šäº†å§ã€‚æˆ‘åˆæµ‹äº†ä¸€ä¸‹è‡ªå®¶çš„ç½‘ç«™ï¼š`{ avg: 473.87, res_95: 657 }`ï¼Œç«Ÿç„¶æ¯”ç™¾åº¦è¦å¿«ğŸ˜‚ï¼Œæœç„¶æˆ‘å¹³å¸¸æ²¡ç™½å¿™æ´»ã€‚

[1]: ./img/concurrent.png
[2]: https://github.com/axios/axios
