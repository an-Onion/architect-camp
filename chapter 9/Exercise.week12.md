# æå®¢æ—¶é—´ã€Šæ¶æ„å¸ˆè®­ç»ƒè¥ã€‹ç¬¬åäºŒå‘¨è¯¾åä½œä¸š

## ç¬¬ä¸€é¢˜

> åœ¨ä½ æ‰€åœ¨çš„å…¬å¸ï¼ˆè¡Œä¸šï¼Œé¢†åŸŸï¼‰å†…ï¼Œæ­£åœ¨ç”¨å¤§æ•°æ®å¤„ç†å“ªäº›ä¸šåŠ¡ï¼Ÿå¯ä»¥ç”¨å¤§æ•°æ®å®ç°å“ªäº›ä»·å€¼ï¼Ÿ

æˆ‘æ˜¯åšæ‹›è˜è½¯ä»¶çš„ï¼Œè¯´å®åœ¨æˆ‘ä»¬å‚æ ¹æœ¬å°±æ²¡æœ‰å¤§æ•°æ® ğŸ˜…ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªé¢†åŸŸé‡Œï¼Œæˆ‘è¿˜æ˜¯å¬è¯´è¿‡ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼Œè¿™é‡Œå°±é“å¬é€”è¯´åˆ—ä¸¾ä¸€äºŒï¼š

- æ•´åˆæ‹›è˜æ¸ é“

  é€šè¿‡å¤§æ•°æ®ç®—æ³•å°†ä¼ä¸šè‡ªæœ‰åº“ã€çŒå¤´ç®€å†åº“ã€äººè„‰ç®€å†åº“ç­‰ç­‰è¿›è¡Œæ•´åˆï¼Œå®ç°å¤šæ¸ é“ç®€å†æœç´¢ã€ç­›é€‰ã€æ ‡è¯†ã€‚

- æ™ºèƒ½æ¨è

  ä¼ä¸š HR ä¸»åŠ¨æœç´¢äººæ‰å¸¸å¸¸è¦èŠ±è´¹è¾ƒå¤§çš„æ—¶é—´å’Œç²¾åŠ›ã€‚é€šè¿‡å¤§æ•°æ®ç®—æ³•å’Œäººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œå¯ä»¥å®ç°ç®—æ³•ä¸»åŠ¨æ¨èå€™é€‰äººï¼Œç›´æ¥æé«˜ HR æ‹›è˜æ•ˆç‡åŠå€™é€‰äººé¢è¯•æˆåŠŸæ¦‚ç‡ã€‚

- ç®¡ç†æµç¨‹æ™ºèƒ½åŒ–

  ä¼ä¸šåœ¨å‘å±•çš„å„ä¸ªé˜¶æ®µéƒ½éœ€è¦é€‚é…æ–°çš„æ‹›è˜æ¨¡å¼ï¼Œå¤§æ•°æ®ç®—æ³•æ ¹æ®å…¨æ¸ é“ä¿¡æ¯ï¼Œå‘ä¼ä¸šä¸»æä¾›æœ€ä½³äººåŠ›èµ„æºç®¡ç†æµç¨‹ï¼Œæ‰“é€šå„åœ°åŒºã€å„éƒ¨é—¨ã€ç”šè‡³æ˜¯å„ä¸ªç¯èŠ‚çš„ä¿¡æ¯é€šè·¯ã€‚

- ä¸ºäººæ‰å†³ç­–æä¾›é‡è¦ä»·å€¼

  é€šè¿‡å¯¹äººåŠ›èµ„æºç®¡ç†ä¸­å„ä¸ªè¡Œä¸ºæ•°æ®å’Œè€ƒè¯„ç»“æœçš„å­¦ä¹ ï¼Œå½¢æˆä¸€å¥—æ–°äººçš„å²—ä½ç´ è´¨æ¨¡å‹ï¼Œä¸º HR æŒ‘é€‰é€‚åˆä¼ä¸šå„ä¸ªå‘å±•é˜¶æ®µçš„äººæ‰æä¾›é‡è¦å‚è€ƒã€‚è¿˜å¯ä»¥æ ¹æ®è¡Œä¸šåŠ¨æ€ã€å¸‚åœºçŠ¶å†µåˆ†æèŒå·¥ç¦»èŒæ„å‘ï¼Œå¸®åŠ© HR å¿«é€Ÿåˆ¶å®šä¸‹ä¸€å¹´çš„æ‹›è˜è®¡åˆ’ã€‚

## ç¬¬äºŒé¢˜

> åˆ†æå¦‚ä¸‹ HiveQLï¼Œç”Ÿæˆçš„ MapReduce æ‰§è¡Œç¨‹åºï¼Œmap å‡½æ•°è¾“å…¥æ˜¯ä»€ä¹ˆï¼Œè¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿreduce å‡½æ•°è¾“å…¥æ˜¯ä»€ä¹ˆï¼Œè¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ

```sql
INSERT OVERWRITE TABLE pv_users
SELECT pv.pageid, u.age
FROM page_view pv
JOIN user u
ON (pv.userid = u.userid)
```

Page_view è¡¨å’Œ user è¡¨ç»“æ„ä¸æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š

![page_view & user][0]

### Map å‡½æ•°

é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹åˆ°è¯¥é¢˜ä¸­ page_view & user ä¸¤è¡¨çš„ JOIN æ“ä½œæ˜¯é€šè¿‡ userid å…³è”çš„ï¼Œæ‰€ä»¥ Map æ“ä½œå¿…ç„¶æ˜¯ä»¥ userid ä¸º key å€¼è¾“å‡ºï¼š

- page_view è¡¨

  | pageid | userid |
  | :----: | :----: |
  |   1    |  111   |
  |   2    |  111   |
  |   1    |  222   |

  - page_view è¡¨å…³è”çš„ Map å‡½æ•°ï¼š`map(key: Offset, value: LineOfPageView, ...)`

    - key æ˜¯ value æ‰€åœ¨è¡Œçš„åç§»é‡ï¼Œä¸€èˆ¬å¯ä»¥ä¸ç®¡
    - value æ˜¯ page_view è¡¨ä¸­æŸä¸€è¡Œçš„æ–‡æœ¬å†…å®¹ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡åˆ†è¯å™¨æå–å‡º`pageid`å’Œ`userid`ç­‰ä¿¡æ¯

  - map å‡½æ•°è¾“å‡ºæ ¼å¼ï¼š`{key: UserId, value: <TableId, PageId>}`

    - key å°±æ˜¯ userid çš„å€¼
    - value æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®æ˜¯è¡¨ç¼–å·ï¼ˆæˆ‘è¿™é‡Œç”¨`pv`ç¼©å†™ç¤ºæ„ä¸€ä¸‹ï¼‰ï¼Œå€¼å°±æ˜¯ pageid

    è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

    | key: UserId | value: <TableId, PageId> |
    | :---------: | :----------------------: |
    |     111     |         <pv, 1>          |
    |     111     |         <pv, 2>          |
    |     222     |         <pv, 1>          |

- user è¡¨

  | userid | age |
  | :----: | :-: |
  |  111   | 25  |
  |  222   | 32  |

  - è¯¥è¡¨å…³è”çš„ Map å‡½æ•°æ˜¯`map(key: Offset, value: LineOfUser, ...)`ï¼Œå‡ ä¹å’Œä¸Šè¡¨ä¸€æ ·ï¼š

    - key æ˜¯åç§»é‡
    - value æ˜¯è¡¨ä¸­æŸä¸€è¡Œçš„æ–‡æœ¬å†…å®¹ï¼Œé€šè¿‡åˆ†è¯å™¨å¯ä»¥æå–å‡º`userid`å’Œ`age`ç­‰ä¿¡æ¯

  - map å‡½æ•°è¾“å‡ºæ ¼å¼ï¼š`{key: UserId, value: <TableId, Age>}`

    - key å°±æ˜¯ userid
    - value ä¹Ÿæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®ä¹Ÿæ˜¯è¡¨ç¼–å·ï¼ˆç”¨`u`ç¼©å†™ç¤ºæ„ï¼‰ï¼Œå€¼å°±æ˜¯ age

    è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

    | key: UserId | age: <TableId, Age> |
    | :---------: | :-----------------: |
    |     111     |       <u, 25>       |
    |     222     |       <u, 32>       |

### Shuffle

Shuffle ä¼šå°†ä¸Šè¿° Map è¾“å‡ºç»“æ„æŒ‰ Key å€¼ï¼ˆuseridï¼‰æ’åºä»¥åŠåˆå¹¶ï¼Œä¼šç”Ÿæˆå¦‚ä¸‹ä¸¤å¼ è¡¨çš„å†…å®¹å†äº¤ç»™ä¸åŒçš„ Reduce æœåŠ¡è®¡ç®—ï¼š

| key: UserId | value: <TableId, AgeOrPageId> |
| :---------: | :---------------------------: |
|     111     |            <u, 25>            |
|     111     |            <pv, 1>            |
|     111     |            <pv, 2>            |

å’Œ

| key: UserId | value: <TableId, AgeOrPageId> |
| :---------: | :---------------------------: |
|     222     |            <u, 32>            |
|     222     |            <pv, 1>            |

### Reduce å‡½æ•°

- è¾“å…¥å°±æ˜¯ä¸Šé¢ Shuffle çš„è¾“å‡ºï¼š

  `reduce(Key: UserId, values: <TableId, AgeOrPageId>[], ...)`

  - key å°±æ˜¯ UserId
  - values æ˜¯ä¸€ç³»åˆ—é”®å€¼å¯¹ï¼ˆ`<u, age>`æˆ–æ˜¯`<pv, pageid>`ï¼‰çš„æ•°ç»„

- è¾“å‡ºï¼š

  ```typescript
  const ages: [] = values.filter((v) => v.key === "u").map((v) => v.value);
  const pageIds: [] = values.filter((v) => v.key === "pv").map((v) => v.value);

  return pageIds.flatMap((p) => ages.map((a) => ({ pageid: p, age: a })));
  ```

  å…ˆåˆ©ç”¨ä¸åŒçš„è¡¨ç¼–å·ï¼ˆ`pv`æˆ–`u`ï¼‰ï¼Œä» values ä¸­è¿‡æ»¤å‡º ages å’Œ pageIds ä¸¤ä¸ªæ•°ç»„ï¼›ç„¶åå¯¹ ages å’Œ pageId è¿™ä¸¤ä¸ªæ•°ç»„åš combination æ“ä½œï¼ˆä¸¤ for å¾ªç¯å•¦ï¼‰ï¼Œå¾—åˆ°æ‰€æœ‰çš„`<pageid, age>`é”®å€¼å¯¹çš„åˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å°±æ˜¯ Reduce çš„è¾“å‡ºã€‚æœ€åè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

  | pageid | age |
  | :----: | :-: |
  |   1    | 32  |
  |   1    | 25  |
  |   2    | 25  |

[0]: ./img/exercise2.png
